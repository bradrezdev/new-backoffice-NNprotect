# ESTRATEGIA DE TESTING FUNCIONAL - SISTEMA DE COMISIONES MLM

**Fecha**: Octubre 2, 2025
**Proyecto**: NNProtect Backoffice MLM
**Responsable**: QA Engineer Giovann
**Objetivo**: Validaci√≥n funcional completa del sistema de comisiones antes de producci√≥n

---

## üìã TABLA DE CONTENIDOS

1. [Alcance del Testing](#alcance-del-testing)
2. [Arquitectura de Tests](#arquitectura-de-tests)
3. [Bonos a Validar](#bonos-a-validar)
4. [Casos de Prueba Cr√≠ticos](#casos-de-prueba-cr√≠ticos)
5. [Fixtures y Factories](#fixtures-y-factories)
6. [Estructura de Archivos](#estructura-de-archivos)
7. [Matriz de Cobertura](#matriz-de-cobertura)
8. [Ejecuci√≥n de Tests](#ejecuci√≥n-de-tests)

---

## 1. ALCANCE DEL TESTING

### Servicios bajo Testing
- ‚úÖ **CommissionService** - C√°lculo de 5 bonos implementados
- ‚úÖ **RankService** - Sistema autom√°tico de rangos
- ‚úÖ **GenealogyService** - Estructura de red MLM
- ‚úÖ **PVUpdateService** - Actualizaci√≥n de cache PV/PVG
- ‚úÖ **ExchangeService** - Conversi√≥n de monedas
- ‚úÖ **WalletService** - Billetera digital
- ‚úÖ **PeriodService** - Gesti√≥n de per√≠odos mensuales

### Bonos Implementados a Validar (5 de 9)
1. ‚úÖ **Bono R√°pido** (Fast Start Bonus) - 30%/10%/5% en kits
2. ‚úÖ **Bono Uninivel** (Unilevel Bonus) - Mensual, 10 niveles
3. ‚úÖ **Bono por Alcance** (Achievement Bonus) - One-time al subir rango
4. ‚úÖ **Bono Matching** - 30%-5% sobre uninivel (solo Embajadores)
5. ‚úÖ **Bono Directo** - 25% del VN en ventas directas

### Reglas Cr√≠ticas de Negocio
- ‚ö†Ô∏è **Kits generan PV pero NO VN** (solo pagan Bono R√°pido)
- ‚ö†Ô∏è **Productos generan PV y VN** (pagan todos los bonos)
- ‚ö†Ô∏è **payment_confirmed_at determina el per√≠odo** (NO created_at)
- ‚ö†Ô∏è **Los rangos NUNCA retroceden**
- ‚ö†Ô∏è **PV m√≠nimo: 1,465 para todos los rangos**
- ‚ö†Ô∏è **Conversi√≥n de monedas con tasas fijas** (NO market rates)

---

## 2. ARQUITECTURA DE TESTS

### Pir√°mide de Testing

```
                    /\
                   /  \
                  / E2E \         10% - Flujos completos end-to-end
                 /------\
                /        \
               / INTEGRA-\       30% - Tests de integraci√≥n entre servicios
              /    CI√ìN   \
             /------------\
            /              \
           /   UNITARIOS    \    60% - Tests unitarios de l√≥gica de negocio
          /------------------\
```

### Tipos de Tests

#### 1. Tests Unitarios (60%)
- **Objetivo**: Validar l√≥gica de negocio aislada
- **Scope**: M√©todos individuales de servicios
- **Ejemplos**:
  - `CommissionService.process_fast_start_bonus()` con datos mockeados
  - `RankService.calculate_rank()` con PV/PVG espec√≠ficos
  - `ExchangeService.convert_amount()` con tasas fijas

#### 2. Tests de Integraci√≥n (30%)
- **Objetivo**: Validar interacci√≥n entre servicios
- **Scope**: M√∫ltiples servicios trabajando juntos
- **Ejemplos**:
  - Orden confirmada ‚Üí PV actualizado ‚Üí Rango promovido ‚Üí Comisi√≥n calculada
  - Usuario registrado ‚Üí Genealog√≠a creada ‚Üí Sponsor en nivel 1
  - Comisi√≥n calculada ‚Üí Depositada en wallet ‚Üí Balance actualizado

#### 3. Tests End-to-End (10%)
- **Objetivo**: Validar flujos completos de usuario
- **Scope**: Desde acci√≥n de usuario hasta resultado final
- **Ejemplos**:
  - Usuario registra ‚Üí Compra kit ‚Üí Confirma pago ‚Üí Genera comisiones a 3 niveles
  - Usuario alcanza PVG requerido ‚Üí Rango promovido ‚Üí Achievement Bonus pagado
  - Cierre de per√≠odo ‚Üí C√°lculo uninivel ‚Üí Dep√≥sito en wallets

---

## 3. BONOS A VALIDAR

### 3.1 BONO R√ÅPIDO (Fast Start Bonus)
**Estado**: ‚úÖ Implementado
**Archivo de Test**: `test_fast_start_bonus.py`

#### Reglas de Negocio
- Aplica solo para productos con `presentation = "kit"`
- Paga 30%/10%/5% del PV del kit a niveles 1/2/3
- Instant√°neo al confirmar pago
- Conversi√≥n a moneda del patrocinador
- Si no hay 3 niveles completos, solo paga los disponibles

#### Casos de Prueba
```python
‚úÖ test_fast_bonus_with_3_levels_complete
‚úÖ test_fast_bonus_with_only_2_levels
‚úÖ test_fast_bonus_with_no_sponsor
‚úÖ test_fast_bonus_multiple_kits_same_order
‚úÖ test_fast_bonus_currency_conversion_mx_to_usa
‚úÖ test_fast_bonus_not_triggered_by_products
‚úÖ test_fast_bonus_percentages_accuracy
```

### 3.2 BONO UNINIVEL (Unilevel Bonus)
**Estado**: ‚úÖ Implementado
**Archivo de Test**: `test_unilevel_bonus.py`

#### Reglas de Negocio
- Solo productos regulares (NO kits) generan VN para Uninivel
- Porcentajes seg√∫n rango del miembro
- Hasta 10 niveles de profundidad (Embajadores: nivel 10+ infinito)
- C√°lculo mensual (d√≠a 31)
- Basado en VN de √≥rdenes confirmadas del per√≠odo

#### Casos de Prueba
```python
‚úÖ test_uninivel_visionario_3_levels
‚úÖ test_uninivel_creativo_5_levels
‚úÖ test_uninivel_embajador_solidario_10plus_levels
‚úÖ test_uninivel_only_products_generate_vn
‚úÖ test_uninivel_kits_excluded
‚úÖ test_uninivel_multi_country_conversion
‚úÖ test_uninivel_period_isolation
‚úÖ test_uninivel_zero_commission_if_no_sales
```

### 3.3 BONO POR ALCANCE (Achievement Bonus)
**Estado**: ‚úÖ Implementado
**Archivo de Test**: `test_achievement_bonus.py`

#### Reglas de Negocio
- Se paga UNA SOLA VEZ por cada rango alcanzado
- Rango Emprendedor: m√°ximo 30 d√≠as desde inscripci√≥n
- Montos fijos por pa√≠s seg√∫n rango
- Trigger autom√°tico al promover rango

#### Casos de Prueba
```python
‚úÖ test_achievement_bonus_first_time_emprendedor
‚úÖ test_achievement_bonus_not_paid_second_time
‚úÖ test_achievement_bonus_emprendedor_30_day_limit
‚úÖ test_achievement_bonus_creativo_no_time_limit
‚úÖ test_achievement_bonus_multi_currency
‚úÖ test_achievement_bonus_embajador_solidario
‚úÖ test_achievement_bonus_rank_never_regresses
```

### 3.4 BONO MATCHING
**Estado**: ‚úÖ Implementado
**Archivo de Test**: `test_matching_bonus.py`

#### Reglas de Negocio
- Solo elegible para rangos Embajador (Transformador+)
- Se calcula sobre comisiones Uninivel de miembros Embajador en el equipo
- Porcentajes: 30%/20%/10%/5% seg√∫n rango y profundidad
- Mensual (despu√©s de calcular Uninivel)

#### Casos de Prueba
```python
‚úÖ test_matching_bonus_embajador_transformador_1_level
‚úÖ test_matching_bonus_embajador_solidario_4_levels
‚úÖ test_matching_not_eligible_if_not_ambassador
‚úÖ test_matching_only_on_ambassadors_uninivel
‚úÖ test_matching_requires_uninivel_calculated_first
‚úÖ test_matching_multi_level_cascading
```

### 3.5 BONO DIRECTO (Direct Bonus)
**Estado**: ‚úÖ Implementado
**Archivo de Test**: `test_direct_bonus.py`

#### Reglas de Negocio
- 25% del VN total de la orden
- Solo al patrocinador directo (sponsor_id)
- Aplica tanto para kits como productos regulares
- Conversi√≥n a moneda del patrocinador

#### Casos de Prueba
```python
‚úÖ test_direct_bonus_25_percent_of_vn
‚úÖ test_direct_bonus_on_kit_purchase
‚úÖ test_direct_bonus_on_product_purchase
‚úÖ test_direct_bonus_no_sponsor
‚úÖ test_direct_bonus_currency_conversion
‚úÖ test_direct_bonus_multiple_orders
```

---

## 4. CASOS DE PRUEBA CR√çTICOS

### 4.1 Edge Cases de Genealog√≠a

#### Test: Red sin 3 niveles completos
```python
def test_fast_bonus_incomplete_upline():
    """
    Escenario:
        A ‚Üí B (solo 2 niveles)

    Acci√≥n: B compra kit Full Protect (5,790 MXN, PV=2,930)

    Esperado:
        - A recibe 30% (879 PV) ‚úÖ
        - Nivel 2 no existe, no se paga ‚úÖ
        - Nivel 3 no existe, no se paga ‚úÖ
    """
```

#### Test: Red profunda (10+ niveles)
```python
def test_uninivel_deep_network_10plus_levels():
    """
    Escenario:
        A (Embajador Solidario) ‚Üí B ‚Üí C ‚Üí ... ‚Üí K (nivel 10) ‚Üí L (nivel 11)

    Acci√≥n: Todos compran productos en el mes

    Esperado:
        - A recibe comisiones de niveles 1-9 con % espec√≠ficos
        - A recibe comisi√≥n de nivel 10+ (todos desde nivel 10 al infinito) ‚úÖ
        - Total niveles 10+: L + todos despu√©s de L ‚úÖ
    """
```

#### Test: Red amplia (100+ directos)
```python
def test_uninivel_wide_network_100_direct_referrals():
    """
    Escenario:
        A (Creativo, 5 niveles) ‚Üí 100 directos (B1...B100)

    Acci√≥n: Todos los 100 directos compran productos

    Esperado:
        - A recibe 5% sobre TODOS los 100 directos (nivel 1) ‚úÖ
        - Performance: Query debe completar en < 2 segundos ‚úÖ
    """
```

### 4.2 Edge Cases de Per√≠odos

#### Test: Orden creada en mes anterior, pagada en mes actual
```python
def test_period_assignment_by_payment_confirmed_at():
    """
    Escenario:
        - Orden creada: 2025-09-30 23:59 UTC (created_at)
        - Pago confirmado: 2025-10-01 00:05 UTC (payment_confirmed_at)

    Esperado:
        - period_id = Octubre 2025 ‚úÖ
        - PV cuenta para Octubre ‚úÖ
        - Comisiones asignadas a Octubre ‚úÖ
    """
```

#### Test: Cambio de rango a mitad de mes
```python
def test_rank_change_mid_month_uninivel_calculation():
    """
    Escenario:
        - Usuario es Visionario (3 niveles) el d√≠a 1
        - Alcanza Creativo (5 niveles) el d√≠a 15
        - Compras en la red: D√≠a 5 (Visionario), D√≠a 20 (Creativo)

    Esperado:
        - Uninivel del mes se calcula con RANGO M√ÅS ALTO del mes ‚úÖ
        - Comisiones de niveles 4-5 solo desde d√≠a 15+ ‚úÖ
    """
```

### 4.3 Edge Cases de Monedas

#### Test: Red internacional (MX ‚Üí USA ‚Üí COL)
```python
def test_multi_country_commission_cascading():
    """
    Escenario:
        A (M√©xico, MXN) ‚Üí B (USA, USD) ‚Üí C (Colombia, COP)

    Acci√≥n: C compra kit Full Protect (COL: 1,300,000 COP)

    Esperado:
        - B recibe 30% en USD (convertido de COP) ‚úÖ
        - A recibe 10% en MXN (convertido de COP) ‚úÖ
        - Exchange rates guardados en commissions ‚úÖ
        - Conversi√≥n usa tasas fijas de la empresa ‚úÖ
    """
```

### 4.4 Edge Cases de Productos

#### Test: Kit vs Producto en mismo orden
```python
def test_mixed_order_kit_and_products():
    """
    Escenario:
        Orden con:
        - 1x Kit Full Protect (genera PV, NO VN)
        - 2x DNA 60 C√°psulas (genera PV y VN)

    Esperado:
        - total_pv = Kit PV + Productos PV ‚úÖ
        - total_vn = 0 (Kit) + Productos VN ‚úÖ
        - Bono R√°pido: Solo sobre kit ‚úÖ
        - Bono Directo: 25% del VN de productos ‚úÖ
        - Bono Uninivel: Solo sobre VN de productos ‚úÖ
    """
```

### 4.5 Edge Cases de Datos

#### Test: NULL values y boundaries
```python
def test_commission_with_zero_amounts():
    """Validar que comisiones de 0 no se crean"""

def test_commission_with_null_sponsor():
    """Validar que usuario sin sponsor no genera comisiones upline"""

def test_commission_decimal_precision():
    """Validar que comisiones tienen precisi√≥n de 2 decimales"""

def test_commission_negative_amounts_rejected():
    """Validar que montos negativos lanzan error"""
```

---

## 5. FIXTURES Y FACTORIES

### Fixtures Reutilizables

#### 5.1 Database Session
```python
@pytest.fixture
def db_session():
    """Sesi√≥n de BD limpia para cada test"""
    with Session(engine) as session:
        yield session
        session.rollback()
```

#### 5.2 Test Users Factory
```python
@pytest.fixture
def test_users_network(db_session):
    """
    Crea red de prueba:
    A ‚Üí B ‚Üí C ‚Üí D
    """
    users = {
        'A': create_test_user(member_id=1000, sponsor_id=None),
        'B': create_test_user(member_id=1001, sponsor_id=1000),
        'C': create_test_user(member_id=1002, sponsor_id=1001),
        'D': create_test_user(member_id=1003, sponsor_id=1002),
    }
    return users
```

#### 5.3 Test Products Factory
```python
@pytest.fixture
def test_kit_full_protect(db_session):
    """Kit Full Protect con PV pero sin VN"""
    return Products(
        SKU="KIT-FULL",
        product_name="Full Protect Kit",
        presentation="kit",
        type="kit",
        pv_mx=2930,
        vn_mx=0,  # ‚ö†Ô∏è CR√çTICO: Kits NO generan VN
        price_mx=5790
    )

@pytest.fixture
def test_product_dna_60(db_session):
    """Producto DNA 60 con PV y VN"""
    return Products(
        SKU="DNA-60",
        product_name="DNA 60 C√°psulas",
        presentation="capsulas",
        type="suplemento",
        pv_mx=1465,
        vn_mx=1465,  # ‚úÖ Productos S√ç generan VN
        price_mx=2490
    )
```

#### 5.4 Test Orders Factory
```python
@pytest.fixture
def create_test_order():
    """Factory function para crear √≥rdenes de prueba"""
    def _create_order(
        member_id: int,
        products: List[Tuple[Products, int]],  # (product, quantity)
        payment_confirmed: bool = True
    ) -> Orders:
        order = Orders(
            member_id=member_id,
            country="Mexico",
            currency="MXN",
            status=OrderStatus.PAYMENT_CONFIRMED.value if payment_confirmed else OrderStatus.DRAFT.value,
            payment_confirmed_at=datetime.now(timezone.utc) if payment_confirmed else None
        )
        # ... calcular totales
        return order

    return _create_order
```

#### 5.5 Test Periods Factory
```python
@pytest.fixture
def test_period_current(db_session):
    """Per√≠odo actual de prueba"""
    period = Periods(
        name="Test Period Oct 2025",
        starts_on=datetime(2025, 10, 1, tzinfo=timezone.utc),
        ends_on=datetime(2025, 10, 31, 23, 59, 59, tzinfo=timezone.utc),
        closed_at=None  # Activo
    )
    db_session.add(period)
    db_session.flush()
    return period
```

---

## 6. ESTRUCTURA DE ARCHIVOS

```
testers/test_commissions/
‚îÇ
‚îú‚îÄ‚îÄ TESTING_STRATEGY.md                 # Este documento
‚îú‚îÄ‚îÄ README.md                            # Gu√≠a r√°pida de ejecuci√≥n
‚îú‚îÄ‚îÄ pytest.ini                           # Configuraci√≥n de pytest
‚îú‚îÄ‚îÄ conftest.py                          # Fixtures compartidas
‚îÇ
‚îú‚îÄ‚îÄ fixtures/                            # Fixtures reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ db_fixtures.py                   # Sesiones de BD
‚îÇ   ‚îú‚îÄ‚îÄ user_fixtures.py                 # Usuarios y genealog√≠a
‚îÇ   ‚îú‚îÄ‚îÄ product_fixtures.py              # Productos y kits
‚îÇ   ‚îú‚îÄ‚îÄ order_fixtures.py                # √ìrdenes de prueba
‚îÇ   ‚îî‚îÄ‚îÄ period_fixtures.py               # Per√≠odos mensuales
‚îÇ
‚îú‚îÄ‚îÄ factories/                           # Factories de datos
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user_factory.py                  # UserFactory
‚îÇ   ‚îú‚îÄ‚îÄ product_factory.py               # ProductFactory
‚îÇ   ‚îú‚îÄ‚îÄ order_factory.py                 # OrderFactory
‚îÇ   ‚îî‚îÄ‚îÄ network_factory.py               # NetworkFactory (redes complejas)
‚îÇ
‚îú‚îÄ‚îÄ unit/                                # Tests unitarios (60%)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_fast_start_bonus.py         # Bono R√°pido
‚îÇ   ‚îú‚îÄ‚îÄ test_unilevel_bonus.py           # Bono Uninivel
‚îÇ   ‚îú‚îÄ‚îÄ test_achievement_bonus.py        # Bono por Alcance
‚îÇ   ‚îú‚îÄ‚îÄ test_matching_bonus.py           # Bono Matching
‚îÇ   ‚îú‚îÄ‚îÄ test_direct_bonus.py             # Bono Directo
‚îÇ   ‚îú‚îÄ‚îÄ test_rank_service.py             # Sistema de rangos
‚îÇ   ‚îú‚îÄ‚îÄ test_pv_update_service.py        # Actualizaci√≥n PV/PVG
‚îÇ   ‚îú‚îÄ‚îÄ test_exchange_service.py         # Conversi√≥n de monedas
‚îÇ   ‚îî‚îÄ‚îÄ test_genealogy_service.py        # Estructura de red
‚îÇ
‚îú‚îÄ‚îÄ integration/                         # Tests de integraci√≥n (30%)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_order_to_commission_flow.py # Orden ‚Üí Comisi√≥n
‚îÇ   ‚îú‚îÄ‚îÄ test_rank_promotion_flow.py      # Promoci√≥n ‚Üí Achievement
‚îÇ   ‚îú‚îÄ‚îÄ test_period_closure_flow.py      # Cierre ‚Üí Uninivel
‚îÇ   ‚îî‚îÄ‚îÄ test_wallet_commission_flow.py   # Comisi√≥n ‚Üí Wallet
‚îÇ
‚îú‚îÄ‚îÄ e2e/                                 # Tests end-to-end (10%)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_new_user_first_purchase.py  # Registro ‚Üí Compra ‚Üí Comisiones
‚îÇ   ‚îú‚îÄ‚îÄ test_rank_progression.py         # Progresi√≥n completa de rangos
‚îÇ   ‚îî‚îÄ‚îÄ test_monthly_commission_cycle.py # Ciclo completo mensual
‚îÇ
‚îú‚îÄ‚îÄ edge_cases/                          # Edge cases cr√≠ticos
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_genealogy_edge_cases.py     # Red incompleta, profunda, amplia
‚îÇ   ‚îú‚îÄ‚îÄ test_period_edge_cases.py        # Cambio de mes, rango a mitad
‚îÇ   ‚îú‚îÄ‚îÄ test_currency_edge_cases.py      # Multi-pa√≠s, conversi√≥n
‚îÇ   ‚îî‚îÄ‚îÄ test_data_edge_cases.py          # NULL, zeros, boundaries
‚îÇ
‚îú‚îÄ‚îÄ regression/                          # Tests de regresi√≥n
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_existing_commissions.py     # Validar comisiones existentes
‚îÇ   ‚îî‚îÄ‚îÄ test_database_migrations.py      # Validar migraciones
‚îÇ
‚îú‚îÄ‚îÄ performance/                         # Tests de performance
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_large_network_queries.py    # Redes de 50k+ usuarios
‚îÇ   ‚îî‚îÄ‚îÄ test_batch_calculations.py       # C√°lculos masivos
‚îÇ
‚îî‚îÄ‚îÄ helpers/                             # Funciones helper
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ assertions.py                    # Asserts personalizados
    ‚îú‚îÄ‚îÄ validators.py                    # Validadores de datos
    ‚îî‚îÄ‚îÄ test_data_cleanup.py             # Limpieza de datos de prueba
```

---

## 7. MATRIZ DE COBERTURA

### Cobertura por Servicio

| Servicio | Tests Unitarios | Tests Integraci√≥n | Cobertura Objetivo | Estado |
|----------|----------------|-------------------|-------------------|--------|
| CommissionService | 35 tests | 10 tests | 95% | üü° En progreso |
| RankService | 20 tests | 8 tests | 95% | üü° En progreso |
| GenealogyService | 15 tests | 5 tests | 90% | üü° En progreso |
| PVUpdateService | 12 tests | 6 tests | 90% | üü° En progreso |
| ExchangeService | 10 tests | 3 tests | 95% | üü° En progreso |
| WalletService | 18 tests | 7 tests | 95% | üü° En progreso |
| PeriodService | 8 tests | 4 tests | 90% | üü° En progreso |

### Cobertura por Bono

| Bono | Casos Base | Edge Cases | Performance | Total | Estado |
|------|-----------|-----------|-------------|-------|--------|
| Bono R√°pido | 7 tests | 5 tests | 2 tests | 14 | üü° |
| Bono Uninivel | 8 tests | 8 tests | 3 tests | 19 | üü° |
| Bono Alcance | 7 tests | 4 tests | 1 test | 12 | üü° |
| Bono Matching | 6 tests | 4 tests | 2 tests | 12 | üü° |
| Bono Directo | 6 tests | 3 tests | 1 test | 10 | üü° |

---

## 8. EJECUCI√ìN DE TESTS

### Comandos B√°sicos

```bash
# Ejecutar todos los tests
pytest testers/test_commissions/

# Ejecutar solo tests unitarios
pytest testers/test_commissions/unit/

# Ejecutar solo tests de un bono espec√≠fico
pytest testers/test_commissions/unit/test_fast_start_bonus.py

# Ejecutar con verbose output
pytest testers/test_commissions/ -v

# Ejecutar con coverage report
pytest testers/test_commissions/ --cov=NNProtect_new_website/mlm_service --cov-report=html

# Ejecutar tests marcados como cr√≠ticos
pytest testers/test_commissions/ -m critical

# Ejecutar tests en paralelo (m√°s r√°pido)
pytest testers/test_commissions/ -n auto
```

### Markers Personalizados

```python
@pytest.mark.critical  # Tests cr√≠ticos que DEBEN pasar
@pytest.mark.edge_case  # Edge cases
@pytest.mark.slow  # Tests lentos (> 5 segundos)
@pytest.mark.integration  # Tests de integraci√≥n
@pytest.mark.e2e  # Tests end-to-end
```

### Configuraci√≥n en pytest.ini

```ini
[pytest]
testpaths = testers/test_commissions
python_files = test_*.py
python_classes = Test*
python_functions = test_*

markers =
    critical: Tests cr√≠ticos que bloquean producci√≥n
    edge_case: Edge cases espec√≠ficos
    slow: Tests que toman m√°s de 5 segundos
    integration: Tests de integraci√≥n entre servicios
    e2e: Tests end-to-end completos
    regression: Tests de regresi√≥n

addopts =
    -v
    --strict-markers
    --tb=short
    --disable-warnings
```

---

## 9. CHECKLIST DE VALIDACI√ìN

### Pre-Producci√≥n Checklist

#### Bono R√°pido ‚úÖ
- [ ] 30%/10%/5% correctos en 3 niveles
- [ ] Solo aplica para kits (presentation="kit")
- [ ] Conversi√≥n de monedas correcta
- [ ] Funciona con upline incompleto (1-2 niveles)
- [ ] No se activa con productos regulares

#### Bono Uninivel ‚úÖ
- [ ] Porcentajes por rango correctos
- [ ] Solo productos generan VN (kits excluidos)
- [ ] Funciona hasta nivel 10+
- [ ] C√°lculo mensual correcto
- [ ] Period isolation (no mezcla meses)
- [ ] Performance con redes grandes (50k+ usuarios)

#### Bono por Alcance ‚úÖ
- [ ] Se paga solo UNA VEZ por rango
- [ ] L√≠mite de 30 d√≠as para Emprendedor
- [ ] Montos correctos por pa√≠s
- [ ] Trigger autom√°tico al promover
- [ ] No se paga si ya se cobr√≥ antes

#### Bono Matching ‚úÖ
- [ ] Solo para rangos Embajador
- [ ] Porcentajes 30%/20%/10%/5% correctos
- [ ] Solo sobre uninivel de Embajadores descendientes
- [ ] C√°lculo despu√©s de Uninivel

#### Bono Directo ‚úÖ
- [ ] 25% del VN correcto
- [ ] Aplica tanto para kits como productos
- [ ] Conversi√≥n de monedas correcta
- [ ] Solo al patrocinador directo

#### Sistema de Rangos ‚úÖ
- [ ] PV m√≠nimo 1,465 verificado
- [ ] PVG por rango correcto
- [ ] Rangos nunca retroceden
- [ ] Promoci√≥n autom√°tica funciona
- [ ] Historial de rangos preservado

#### Per√≠odos ‚úÖ
- [ ] payment_confirmed_at determina per√≠odo
- [ ] PV/PVG reset d√≠a 1 del mes
- [ ] Cierre autom√°tico √∫ltimo d√≠a
- [ ] Per√≠odo actual correctamente identificado

#### Conversi√≥n de Monedas ‚úÖ
- [ ] Tasas fijas de la empresa (NO market)
- [ ] Exchange rate guardado en comisi√≥n
- [ ] Soporte multi-pa√≠s (MX/USA/COL)

#### Wallet ‚úÖ
- [ ] Comisiones depositadas correctamente
- [ ] Balance nunca negativo
- [ ] Transacciones inmutables
- [ ] UUID para idempotencia

---

## 10. PR√ìXIMOS PASOS

### Fase 1: Setup (Completar en 1 d√≠a)
1. ‚úÖ Crear estructura de directorios
2. ‚úÖ Documentar estrategia (este archivo)
3. üü° Implementar fixtures base
4. üü° Implementar factories
5. üü° Configurar pytest.ini

### Fase 2: Tests Unitarios (Completar en 3 d√≠as)
1. üü° Implementar tests de Bono R√°pido (7 tests)
2. üü° Implementar tests de Bono Uninivel (8 tests)
3. üü° Implementar tests de Bono por Alcance (7 tests)
4. üü° Implementar tests de Bono Matching (6 tests)
5. üü° Implementar tests de Bono Directo (6 tests)

### Fase 3: Tests de Integraci√≥n (Completar en 2 d√≠as)
1. üü° Flujo Orden ‚Üí Comisi√≥n
2. üü° Flujo Rango ‚Üí Achievement
3. üü° Flujo Per√≠odo ‚Üí Uninivel
4. üü° Flujo Comisi√≥n ‚Üí Wallet

### Fase 4: Edge Cases (Completar en 2 d√≠as)
1. üü° Edge cases de genealog√≠a
2. üü° Edge cases de per√≠odos
3. üü° Edge cases de monedas
4. üü° Edge cases de datos

### Fase 5: Validaci√≥n Final (Completar en 1 d√≠a)
1. üü° Ejecutar suite completa
2. üü° Generar reporte de coverage
3. üü° Validar checklist pre-producci√≥n
4. üü° Documentar issues encontrados

---

## üìû CONTACTO

**QA Engineer**: Giovann
**Proyecto**: NNProtect Backoffice MLM
**Fecha**: Octubre 2025

Para consultas o issues encontrados durante testing, documentar en:
- `/testers/test_commissions/ISSUES_LOG.md`
